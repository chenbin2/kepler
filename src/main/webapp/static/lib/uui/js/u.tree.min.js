+function($){"use strict";var Tree=function(a,b){this.$element=$(a),this.options=$.extend({},$.fn.tree.defaults,b),this.formatData(),this.build(b),this.$element.on("click",".tree-item",$.proxy(function(a){this.selectChildren(a.currentTarget)},this)),this.$element.on("click",".tree-folder-header",$.proxy(function(a){this.selectParent(a.currentTarget)},this)),this.$element.on("click",":checkbox",$.proxy(function(a){this.checkParent(a.currentTarget)},this)),this.$element.on("mousedown",".tree-folder-name,.tree-item-name",$.proxy(function(a){this.popMenu(a.currentTarget,a)},this)),this.$element.on("contextmenu",".tree-folder-header,.tree-item-name",$.proxy(function(a){this.initContextmenu(a)},this))};Tree.prototype={constructor:Tree,setDataSource:function(a){this.options.data=a,this.formatData(),this.build(this.options)},formatData:function(){var a=this.options.data,b=new Array,c=this;this.notHasParentData=new Array,this.hasParentData=new Array,a&&($.each(a,function(){var a=$(this).attr("pid");""==a?c.notHasParentData.push(this):c.hasParentData.push(this)}),$.each(this.hasParentData,function(b){var d=$(this).attr("pid"),e=!1;$.each(a,function(){$(this).attr("id")==d&&(e=!0)}),e||(c.hasParentData.splice(b,0),c.notHasParentData.push(this))}),$.each(this.notHasParentData,function(){b.push(this),c.pushChildren(this)}),this.options.data=b)},pushChildren:function(a){var b=this,c=new Array;$.each(this.hasParentData,function(d){this&&$(this).attr("pid")==$(a).attr("id")&&(c.push(this),b.hasParentData.splice(d,0),b.pushChildren(this))}),a.children=c},build:function(options){var self=this;""==options.ajaxUrl||null==options.ajaxUrl?self.render():$.ajax({type:"POST",url:options.ajaxUrl,dataType:"text",data:options.reqParam,success:function(data){options.data=eval(data),self.render()},error:function(){}})},render:function(){this.populate(this.options.data,this.$element),this.$element.find(".tree-folder").show(),this.$element.find(".tree-item").show()},populate:function(a,b){var c=this;a&&$.each(a,function(a,d){var e;c.isEmpty(d.children)&&"parent"!=d.type?(e=c.createChildren(),e.find(".tree-item-name").html(d.title),e.attr("href",d.href),e.attr("id",d.id),e.attr("pid",d.pid),e.attr("title",d.title),e.data(d.id),d.icon&&e.children("i").addClass(d.icon).prop("icon",d.icon)):(e=c.createParent(),e.find(".tree-folder-name").html(d.title),e.find(".tree-folder-header").data(d.id),e.find(".tree-folder-header").attr("id",d.id),e.find(".tree-folder-header").attr("pid",d.pid),e.find(".tree-folder-header").attr("title",d.title),c.populate(d.children,e.find(".tree-folder-content:eq(0)")),e.find(".tree-folder-content:eq(0)").hide(),d.icon&&e.children(".tree-folder-header").children("i").addClass(d.icon).prop("icon",d.icon)),b.append(e)})},isEmpty:function(a){if(!a)return!0;for(var b in a)if(a.hasOwnProperty(b))return!1;return!0},createParent:function(){var a;return a=$(this.options.useChkBox?'<div class="tree-folder checkbox" style="display:none;"><input type="checkbox"><div class="tree-folder-header"><i class="fa fa-caret-right"></i><div class="tree-folder-name"></div></div><div class="tree-folder-content"></div><div class="tree-loader" style="display:none"></div></div>':'<div class="tree-folder" style="display:none;"><div class="tree-folder-header"><i class="fa fa-caret-right"></i><div class="tree-folder-name"></div></div><div class="tree-folder-content"></div><div class="tree-loader" style="display:none"></div></div>')},createChildren:function(){var a;return a=$(this.options.useChkBox?'<div class="tree-item checkbox" style="display:none;"><input type="checkbox"><div class="tree-item-name"></div></div>':'<div class="tree-item" style="display:none;"><i class="glyphicon glyphicon-list-alt"></i><div class="tree-item-name"></div></div>')},selectChildren:function(a){var b=$(a),c=this.$element.find(".tree-selected"),d=[],e=b.attr("id"),f=b.attr("pid"),g=b.attr("title"),h={id:e,pid:f,title:g},i=this.options.onSelect;if(i)return void i(b);if("function"!=typeof this.options.onBeforeSelected||this.options.onBeforeSelected.call(this,this,h)){this.options.multiSelect?$.each(c,function(a,c){var e=$(c);e[0]!==b[0]&&d.push($(c).data())}):c[0]!==b[0]&&(c.removeClass("tree-selected").find("i").removeClass("glyphicon-ok").addClass("glyphicon-list-alt"),d.push(b.data())),b.hasClass("tree-selected")?(b.removeClass("tree-selected"),b.find("i").removeClass("glyphicon-ok").addClass("glyphicon-list-alt"),b.find("i").prop("icon")&&b.find("i").addClass(b.find("i").prop("icon"))):(b.addClass("tree-selected"),b.find("i").removeClass("glyphicon-list-alt").addClass("glyphicon-ok"),this.options.multiSelect&&d.push(b.data())),d.length&&this.$element.trigger("selected",{info:d});var j=b.find("input[type='checkbox']");if(j.length>0){var k=j.prop("checked");j.prop("checked",!k)}"function"==typeof this.options.onSelected&&this.options.onSelected.call(this,this,h)}},selectParent:function(a){var b=$(a),c=b.parent(),d=this.$element.find(".tree-selected"),e=b.attr("id"),f=b.attr("pid"),g=b.attr("title"),h={id:e,pid:f,title:g};if("function"!=typeof this.options.onBeforeSelected||this.options.onBeforeSelected.call(this,this,h)){b.find(".fa-caret-right").length?(c.find(".tree-folder-content").children().length&&c.find(".tree-folder-content:eq(0)").show(),c.find(".fa-caret-right:eq(0)").removeClass("fa-caret-right").addClass("fa-caret-down"),this.options.multiSelect||d.removeClass("tree-selected"),b.addClass("tree-selected"),this.$element.trigger("opened",{element:b,data:b.data()})):(this.options.cacheItems?c.find(".tree-folder-content:eq(0)").hide():c.find(".tree-folder-content:eq(0)").empty(),c.find(".fa-caret-down:eq(0)").removeClass("fa-caret-down").addClass("fa-caret-right"),b.removeClass("tree-selected"),this.$element.trigger("closed",{element:b,data:b.data()}));var i=c.find("input[type='checkbox']");if(i.length>0){var j=i.prop("checked");i.prop("checked",!j)}"function"==typeof this.options.onSelected&&this.options.onSelected.call(this,this,h)}},selectedItems:function(){var a=this.$element.find(".tree-selected"),b=[];return $.each(a,function(a,c){var d=$(c).attr("id"),e=$(c).attr("pid"),f=$(c).attr("title"),g={id:d,pid:e,title:f};b.push(g)}),b},checkParent:function(a){var b=$(a),c=b.prop("checked");b.parent().find("[type='checkbox']").prop("checked",c)},popMenu:function(a,b){var c=this.options.mouseMenu,d=$(a);if(null==c)return!1;if(3==b.which){c.hide(),c.css({position:"absolute",top:b.clientY,left:b.clientX}),c.show("fast");var e=null;d.hasClass("tree-folder-name")?e=d.parent().parent():d.hasClass("tree-item-name")&&(e=d.parent()),d.prop("node",e.attr("id")),console.info(d+".node = "+d.prop("node"))}},initContextmenu:function(a){this.$element.trigger("rightClick",a)},createRightMenu:function(a){var b=this;$(".tree-right-menu").remove();var c=$(a.element),d=a.event,e=a.data,f=new Array;f.push('<ul class="dropdown-menu tree-right-menu">'),$.each(e,function(){f.push('<li action="'+this.action+'"><a>'+this.title+"</a></li>")}),f.push("</ul>"),$(f.join("")).appendTo($("body")).show().css({position:"fixed",left:d.pageX,top:d.pageY}).on("mouseleave",function(){$(this).remove()}).find("li").on("click",function(){var a=$(this);c.hasClass("tree-item-name")?b.$element.trigger(a.attr("action"),c.parent()):b.$element.trigger(a.attr("action"),c),a.parent().remove()})},addChildren:function(a){var b=this,c=$(a.node),d=null,e=a.menu;a.type&&"parent"==a.type?(d=b.createParent(),d.find(".tree-folder-name").html(e.title),d.find(".tree-folder-header").data(e),d.on("click",{element:$(this)},function(a){b.selectParent(a.data.element)})):(d=b.createChildren(),d.find(".tree-item-name").html(e.title),d.data(e),d.on("click",{element:$(this)},function(a){b.selectChildren(a.data.element)})),d.show().on("contextmenu",function(a){b.initContextmenu(a)}),c.parent().find(">.tree-folder-content").append(d).show(),c.find(".fa-caret-right").length>0&&c.trigger("click")},removeChildren:function(a){$(a).remove()}},$.fn.tree=function(a,b){var c,d=this.each(function(){var d=$(this);d.addClass("tree");var e=d.data("koala.tree"),f="object"==typeof a&&a;e||d.data("koala.tree",e=new Tree(this,f)),this.treeObj=e,"string"==typeof a&&(c=e[a](b))});return null!=a.mouseMenu&&$(document).bind("contextmenu",function(){return!1}),a.draggable,void 0===c?d:c},$.fn.tree.defaults={multiSelect:!1,loadingHTML:"<div>Loading...</div>",cacheItems:!0,useChkBox:!1,draggable:!1,mouseMenu:null,ajaxUrl:"",reqParam:null,data:null,onSelect:null},$.fn.tree.Constructor=Tree}(window.jQuery);